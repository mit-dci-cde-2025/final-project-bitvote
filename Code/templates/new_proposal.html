<!DOCTYPE html>
<html lang="en">
<head>
  {% if category_id %}
    <title>Level Up Proposal</title>
{% else %}
    <title>New Proposal</title>
{% endif %}
  <title>New Proposal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">

      {% if category_id %}
          <h1>Submit Level Up Proposal</h1>
      {% else %}
          <h1>Create Proposal</h1>
      {% endif %}
      <a href="/" class="btn btn-outline-secondary">Back</a>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input id="title" class="form-control" maxlength="256" placeholder="Proposal title..." />
        </div>
        {% if not category_id %}
        <div class="mb-3">
          <label class="form-label">Layer</label>
          <select id="layer" class="form-control" name="layer" required>
              <option value="" disabled selected>-- Select --</option>
              <option value="consensus-soft-fork">Consensus (soft fork)</option>
              <option value="consensus-hard-fork">Consensus (hard fork)</option>
              <option value="peer-services">Peer Services</option>
              <option value="api-rpc">API/RPC</option>
              <option value="applications">Applications</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Type</label>
          <select id="type" name="type" class="form-control" required>
            <option value="" disabled selected>-- Select --</option>
            <option value="standards-track">Standards Track</option>
            <option value="informational">Informational</option>
            <option value="process">Process</option>
          </select>
        </div>
        {% endif %}

        <div class="mb-3">
          <label class="form-label">Abstract</label>
          <textarea id="abstract" class="form-control" maxlength="6000" placeholder="Tell me a bit more about the proposal!" rows="6"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Motivation</label>
          <textarea id="motivation" class="form-control" maxlength="10000" placeholder="Motivation?" rows="6"></textarea>
        </div>

        {% if category_id %}
        <div class="mb-3">
          <label class="form-label">Specification</label>
          <textarea id="specification" class="form-control" maxlength="20000" placeholder="Exact details about the implementation" rows="10"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Backward Compatibility</label>
          <textarea id="back-compat" class="form-control" maxlength="6000" placeholder="Any Backward Compatibility Issues?" rows="6"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Copyright Information</label>
          <input type="text" id="copyright" class="form-control" maxlength="60" placeholder="Copyright">
        </div>
        {% endif %}

        <div class="mb-3">
          <label class="form-label">Ends in (blocks)</label>
          <input id="duration" type="number" class="form-control" value="2000" min="2000" max="4000" />
        </div>

        <div class="d-flex gap-2">
          <button id="connect" class="btn btn-primary">Connect Wallet</button>
          <button id="submit" class="btn btn-success" disabled>Submit Proposal</button>
        </div>

        <div id="status" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { connect, isConnected, openContractCall } from "https://esm.sh/@stacks/connect";
    import { stringUtf8CV, uintCV } from "https://esm.sh/@stacks/transactions";

    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connect");
    const submitBtn = document.getElementById("submit");

    function setStatus(msg, kind="info") {
      statusEl.className = `alert alert-${kind}`;
      statusEl.textContent = msg;
    }

    async function ensureConnected() {
      if (!isConnected()) {
        await connect({ enableLocalStorage: true, forceWalletSelect: true });
      }
      submitBtn.disabled = !isConnected();
      connectBtn.textContent = isConnected() ? "Wallet Connected" : "Connect Wallet";
      connectBtn.disabled = isConnected();
    }

    async function submitProposal() {
      const catId = "{{ category_id }}";
      const functionName = catId ? "submit-level-up-and-cleanup" : "submit-proposal-and-cleanup";
        
      const title = document.getElementById("title").value.trim();
      const abstract = document.getElementById("abstract").value.trim();
      const motivation = document.getElementById("motivation").value.trim();
      const duration = Number(document.getElementById("duration").value);

      if (!title) return setStatus("Please enter a title.", "warning");
      if (!abstract) return setStatus("Please enter an abstract.", "warning");
      if (!motivation) return setStatus("Please enter a motivation.", "warning");
      if (!Number.isFinite(duration) || duration < 1) return setStatus("Duration must be a positive number.", "warning");

      await ensureConnected();

      let args = [];
      if (catId) {
        const specification = document.getElementById("specification").value.trim();
        const back_compat = document.getElementById("back-compat").value.trim();
        const copyright = document.getElementById("copyright").value.trim();
      
        if (!specification) return setStatus("Please enter a specification.", "warning");
        if (!copyright) return setStatus("Please enter the copyright information.", "warning");
        if (!back_compat) return setStatus("Please enter the backwards compatibility information.", "warning");
        
        args = [uintCV(catId), stringUtf8CV(title), stringUtf8CV(abstract), stringUtf8CV(motivation), uintCV(duration), stringUtf8CV(copyright), stringUtf8CV(specification), stringUtf8CV(back_compat), "{{stale}}"];
      } else {
        const layer = document.getElementById("layer").value.trim();
        const type = document.getElementById("type").value.trim();

        if (!layer) return setStatus("Please enter a layer.", "warning");
        if (!type) return setStatus("Please enter a type.", "warning");
        
        args = [stringUtf8CV(title), stringUtf8CV(layer), stringUtf8CV(type), stringUtf8CV(abstract), stringUtf8CV(motivation), uintCV(duration), "{{stale}}"];
      }

      await openContractCall({
        contractAddress: "{{ contract_addr }}",
        contractName: "{{ contract_name }}",
        functionName: functionName,
        functionArgs: args,
        onFinish: (data) => {
          console.log("Submitted:", data);
          setStatus("Transaction submitted! Check explorer for confirmation.", "success");
        },
        onCancel: () => setStatus("Cancelled.", "secondary"),
        network: "{{ network }}",
      });
    }

    connectBtn.addEventListener("click", ensureConnected);
    submitBtn.addEventListener("click", submitProposal);

    ensureConnected().catch(() => {});
  </script>
</body>
</html>
